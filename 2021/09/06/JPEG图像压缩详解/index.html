<!DOCTYPE html>
<html>



<head>
  <meta charset="utf-8">
  
  
  <title>JPEG图像压缩详解 | ywy_c_asm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="本文讲解了JPEG图像的存储格式、压缩原理以及代码实现。">
<meta property="og:type" content="article">
<meta property="og:title" content="JPEG图像压缩详解">
<meta property="og:url" content="https://www.ywy-c-asm.cn/2021/09/06/JPEG%E5%9B%BE%E5%83%8F%E5%8E%8B%E7%BC%A9%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="ywy_c_asm">
<meta property="og:description" content="本文讲解了JPEG图像的存储格式、压缩原理以及代码实现。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdn.net/20180608145023493?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FzYWhpbm9rYXdh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/06/h5Puzn.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/06/h5Zm7t.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/06/h5ZUA0.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/06/h50tbR.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/06/h50M5V.png">
<meta property="og:image" content="https://z3.ax1x.com/2021/09/06/h5aB8g.png">
<meta property="article:published_time" content="2021-09-06T15:10:00.000Z">
<meta property="article:modified_time" content="2022-04-19T14:33:10.347Z">
<meta property="article:author" content="ywy_c_asm">
<meta property="article:tag" content="图像处理">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdn.net/20180608145023493?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FzYWhpbm9rYXdh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70">
  
  
    <link rel="icon" href="/images/ico.ico">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>



  <div id="container">
    <div id="wrap">

	
		
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ywy_c_asm</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">菜 是 原 罪 | 罪 原 是 菜</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.ywy-c-asm.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer" style="padding:0 0px">
        <section id="main"><article id="post-JPEG图像压缩详解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/09/06/JPEG%E5%9B%BE%E5%83%8F%E5%8E%8B%E7%BC%A9%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2021-09-06T15:10:00.000Z" itemprop="datePublished">2021-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      JPEG图像压缩详解
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文讲解了JPEG图像的存储格式、压缩原理以及代码实现。</p>
<span id="more"></span>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最简单的图像存储格式是BMP位图，它直接把每个位置的像素RGB值存起来，体积会很大。</p>
<p>那么如何把一个图像进行压缩呢？我们要知道，<strong>图像</strong>本质是<strong>连续</strong>的二维信息（当然，除非这图像全是乱码，不是给人看的……），像素值只是对它的离散采样而已。BMP位图只是把图像简简单单地当成一个二维数组，并没有很好的利用其连续性。</p>
<p>举个例子，假如现在有一幅$2000×2000$的被红色填满的图像，用BMP存储，图像大小至少是$2000×2000×3Bytes=11MB$，可是像素值全是$(255,0,0)$，这样显然不优美。当然，更多的例子则是，图像的相邻像素颜色值的差别一般都不大。</p>
<p>JPEG图像压缩的原理就是利用这种连续性，再结合人眼的一些特性，去除掉一些人眼不敏感的信息，把原图用<strong>尽量小</strong>的整数表示，最后用<strong>变长</strong>的二进制编码存储它们。<strong>这种压缩是有损的。</strong></p>
<p>本文共分为两部分，第一部分是JPEG压缩算法流程的介绍，第二部分是JPEG文件存储格式的介绍。毕竟，我最近在手动实现JPEG编/解码器的时候找了大量资料，发现这两个重要的内容往往是割裂的，光知道这算法咋搞的也没用，它在实际上会以一种十分诡异的方式存储，错一点就挂掉了，导致我花了大量时间去探索。</p>
<h1 id="JPEG图像压缩算法"><a href="#JPEG图像压缩算法" class="headerlink" title="JPEG图像压缩算法"></a>JPEG图像压缩算法</h1><h2 id="1-颜色的变换"><a href="#1-颜色的变换" class="headerlink" title="1. 颜色的变换"></a>1. 颜色的变换</h2><p>大家都知道，计算机内一般以RGB值表示一个像素的颜色，我们把这个称作<strong>RGB颜色空间</strong>，在其中三种颜色分量被视作地位相等的（所以，位图必须以相同的形式把3种颜色分量都存起来）。</p>
<p>然而事实真的如此吗？并不。由于人体的视神经结构，人眼对于亮度更加敏感。而当颜色值相同时，绿色的亮度要比红色和蓝色都要明显的高。所以就有这样一种不同于RGB的基于亮度的<strong>YUV颜色空间</strong>（一般和<strong>YCbCr空间</strong>指同一个东西），Y分量表示亮度，U和V分量共同表示色度。RGB与YUV的转换关系如下：</p>
<p>$\begin{bmatrix}Y\U\V\end{bmatrix}=\begin{bmatrix}0.299&amp;0.587&amp;0.114\-0.169&amp;-0.331&amp;0.5\0.5&amp;-0.419&amp;-0.081\end{bmatrix}\begin{bmatrix}R\G\B\end{bmatrix}$</p>
<p><strong>（注意：由于U和V可能是负的，在实际操作中，需要把U和V分别加上128）</strong></p>
<p>这两种颜色空间各自都有长处，RGB对机器十分友好，易于存储，而YUV更加人性化，考虑到了人的视觉特性。</p>
<p><img src="https://img-blog.csdn.net/20180608145023493?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FzYWhpbm9rYXdh/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p>
<p>JPEG在压缩时，先把颜色变换到YUV，由于人眼对Y的敏感程度远高于U和V，所以一般使用$Y:U:V=2:1:1$的采样方式。啥意思呢？每个格子都得提供Y，但U和V则是把图像划分为若干$2×2$的连续子矩阵，每个矩阵里仅取一个U和V（一般是平均值），这样就利用了图像的连续性以及人眼的敏感特性，使得U和V少存了一半。这也是其“有损”的第一个来源。</p>
<p>对于Y、U、V三个分量，我们需要分别把它们划分成若干个$8×8$的连续子矩阵。也就是说，我们需要把图像的宽度和高度补成16的倍数（毕竟U和V是两行/列一采样）。每个$8×8$的子矩阵是JPEG存储的基本单位，我们后续的工作就是如何<strong>把这些$8×8$矩阵压缩并存储</strong>，基本上就不考虑它是哪个分量提供的了。</p>
<h2 id="2-DCT变换以及量化"><a href="#2-DCT变换以及量化" class="headerlink" title="2. DCT变换以及量化"></a>2. DCT变换以及量化</h2><p>众所周知，一维的信号可以通过傅里叶变换转成频域，这样就能把一个连续信号拆成若干正/余弦波的叠加组合。其实二维的图像也可以如此，只不过拆成的是形如$\sin(ax+by)$这样的二维平面波而已。低频波反映了图像的主体，高频波反映了图像的细节，所以<strong>人眼对低频波的敏感程度要高于高频波</strong>。</p>
<p>（感兴趣的同学可以去尝试用二维FFT对图像做变换，然后尝试把低频波或高频波去掉，再IDFT回去看看图像变成了啥，挺有意思的，这里就不展开讲了，毕竟JPEG也不需要FFT……）</p>
<p>而<strong>DCT</strong>（离散余弦变换）是离散傅里叶变换的一种特殊形式，它相当于把原信号做了偶延拓，仅用余弦表示原信号，并不会涉及复数（在DFT中，复数的实部是余弦的系数，虚部是正弦的系数）。</p>
<p>现在我们需要对这些$8×8$矩阵分别做DCT，做法是用矩阵乘法，$T_{8×8}[i][j]=\left{\begin{aligned}\frac 1{\sqrt 8}\space(i=0) \ \frac{\cos(\frac{\pi(2j+1)i}{16})}{2}\space(i&gt;0)\end{aligned}\right.$，那么$DCT(A)=TAT^T$。</p>
<p>下面是一个实际的DCT后的矩阵的例子：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/h5Puzn"><img src="https://z3.ax1x.com/2021/09/06/h5Puzn.png" alt="h5Puzn.png"></a></p>
<p>可以看到，左上角第一个元素的值是明显高于右下方元素的，基本上所有正常的图像都是如此，低频波远高于高频波。那个第一个元素其实就是两个维度振幅都为0的余弦波，其实也就是常数，我们把它称为<strong>直流系数</strong>，其余元素都表示有振幅的余弦波，被称为<strong>交流系数</strong>。可以发现，直流系数是对图像影响较大的因子，于是我们可以采取和之前的YUV类似的思想，把一些不太重要的高频信息过滤掉，于是就需要<strong>量化</strong>操作。</p>
<p>所谓量化操作其实就是一个$8×8$常量矩阵，让DCT后的矩阵里的所有数去与这个量化矩阵进行对应位相除，再四舍五入<strong>取整</strong>（这也是JPEG的第二个“有损”的来源），得到一个整数矩阵，我们实际压缩的就是这个整数矩阵。</p>
<p>一般的，对于Y分量和UV分量的矩阵，会采取两个不同的量化矩阵，以下是Windows画图采取的Y量化矩阵和UV量化矩阵（这个是我在画图保存的jpg文件的二进制信息里提取的）：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/h5Zm7t"><img src="https://z3.ax1x.com/2021/09/06/h5Zm7t.png" alt="h5Zm7t.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/h5ZUA0"><img src="https://z3.ax1x.com/2021/09/06/h5ZUA0.png" alt="h5ZUA0.png"></a></p>
<p>可以发现，量化表的右下部分的值会比左上值大，这其实就相当于对高频的滤波。除完后矩阵内的整数会缩小，并且有很多位置会变成0，这就给数据的压缩存储带来了便利。也就是说，量化表里的数越大，损失越大，但压缩效果越好，可以根据损失程度的需要对量化表的数值大小进行调整。</p>
<h2 id="3-基于Huffman编码的压缩"><a href="#3-基于Huffman编码的压缩" class="headerlink" title="3. 基于Huffman编码的压缩"></a>3. 基于Huffman编码的压缩</h2><p>现在我们得到了一堆$8×8$整数矩阵，并且其中有相当多的0，现在要对它们进行压缩。不过在此之前，由于直流系数数值较大，我们可以继续利用图像的连续性，对相邻矩阵的直流系数进行<strong>差分</strong>，这样就大大缩小了直流系数的值。这个差分的顺序比较奇怪，我们在后面的实现部分再提。</p>
<p>首先，我们需要把二维的矩阵转为一维的整数序列，在这里我们使用<strong>Z字形扫描</strong>对矩阵进行遍历，这样能够充分的利用连续性（其实目的是为了让连续的0尽可能多），如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/h50tbR"><img src="https://z3.ax1x.com/2021/09/06/h50tbR.png" alt="h50tbR.png"></a></p>
<p>此时，序列的第一个数是（经过差分后的）直流系数，我们先不管它。剩下的63个交流系数，对于每个非0值$y$，假设它前面有$x$个0，那么我们用二元组$(x,y)$表示，这就是典型的<strong>游程长度编码</strong>。</p>
<p>那么你可能就会问了，我原来存一个$y$只需要一个字节，现在存这个二元组就需要两个字节，这不是一种浪费吗？并非如此，因为JPEG的压缩方式是<strong>变长编码</strong>，而非一般意义上的定长编码（例如byte,short,int这样的长度固定的整型），所以，真正的压缩数据并非一串字节序列，而是一串<strong>二进制位序列</strong>！</p>
<p>对于$y$，我们求出它的二进制长度$len$。但是，$y$有可能是负的，在这里JPEG使用一种特殊规则存储变长二进制整数，如下表所示：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/h50M5V"><img src="https://z3.ax1x.com/2021/09/06/h50M5V.png" alt="h50M5V.png"></a></p>
<p>这样，原来的二元组就变成了三元组$(x,len,y)$，实际上我们把$x$和$len$视作一个元素，它还是一个二元组$(x/len,y)$。在实际存储的时候，$y$直接存长为$len$的二进制序列，而$x/len$则使用<strong>Huffman编码</strong>表示。一般的，我们需要4棵Huffman树，分别对应Y、UV的直流（直流其实就是序列的第一个元素，不带$x$的$(len,y)$）和交流部分。这样，给定一个二进制序列，我们就能还原出所有的三元组（Huffman码在前，$y$在后）了。</p>
<p>注意，如果这个序列以0结尾，那么只需要在最后一个非0数后插一个三元组$(0/0,0)$表示后面直到结尾都是0。<strong>注意：如果序列结尾不是0，那么不需要非得以这个标记结尾。</strong>（这个把我坑惨了qaq……）</p>
<p>所以，JPEG中，Huffman编码并不是用来压缩实际的数的，而是用来压缩数的长度信息的。毕竟，数可能不少，但是我们已经让它们缩的很小，长度值也就那几个，再者，这其中还蕴含了中间被压掉的0。</p>
<h1 id="JPEG图像存储格式"><a href="#JPEG图像存储格式" class="headerlink" title="JPEG图像存储格式"></a>JPEG图像存储格式</h1><p>下面我们来考虑更加实际的问题，这些东西具体是如何存在JPG图像文件里的？我们就来看看JPG文件的字节码里面都有些什么东西。</p>
<p><strong>FBI Warning：由于种种历史原因，JPEG图像文件中的所有整数全部使用大端方式存储，也就是说整数的高位字节在地址较低的位置，这与平常x86平台上使用的小端方式相反。</strong></p>
<p>JPEG图像一般使用JIFF格式进行存储，它会在文件中划分出若干个段，每段的开头都是“0xFF+段类型字节码”的双字节标识，并且，<strong>0xFF是一个很特殊的字节</strong>，它一般是用来标识段的，如果它出现在实际数据里，后面需要加一个0字节表示这个0xFF是实际数据的一部分。</p>
<p>以下是一些主要的段，不重要的段我直接忽略了。</p>
<h3 id="1-文件起始（SOI）"><a href="#1-文件起始（SOI）" class="headerlink" title="1. 文件起始（SOI）"></a>1. 文件起始（SOI）</h3><table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFD8，表示JPG文件开始</td>
</tr>
</tbody></table>
<h3 id="2-应用程序保留标记0（APP0）"><a href="#2-应用程序保留标记0（APP0）" class="headerlink" title="2. 应用程序保留标记0（APP0）"></a>2. 应用程序保留标记0（APP0）</h3><table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFE0，标识码</td>
</tr>
<tr>
<td>0x02</td>
<td>2</td>
<td>本段除标识码外的字节数</td>
</tr>
<tr>
<td>0x04</td>
<td>5</td>
<td>0X4A6494600，表示字符串“JFIF”</td>
</tr>
<tr>
<td>0x09</td>
<td>2</td>
<td>一般为0x0101，表示JIFF的版本号</td>
</tr>
<tr>
<td>0x0B</td>
<td>1</td>
<td>一般为1，X,Y方向的密度单位，0：无单位；1：点数每英寸；2：点数每厘米。</td>
</tr>
<tr>
<td>0x0C</td>
<td>2</td>
<td>X方向像素密度，一般为120dpi</td>
</tr>
<tr>
<td>0x0E</td>
<td>2</td>
<td>Y方向像素密度</td>
</tr>
<tr>
<td>0x10</td>
<td>1</td>
<td>缩略图宽度，为0表示没有缩略图</td>
</tr>
<tr>
<td>0x11</td>
<td>1</td>
<td>缩略图高度，为0表示没有缩略图</td>
</tr>
<tr>
<td>0x12</td>
<td>3的倍数</td>
<td>缩略图的RGB像素值，可以空着</td>
</tr>
</tbody></table>
<h3 id="3-量化表（DQT）"><a href="#3-量化表（DQT）" class="headerlink" title="3. 量化表（DQT）"></a>3. 量化表（DQT）</h3><p>注意：一个DQT段可以放多个量化表，或者多个量化表也可以放在多个DQT段里（Windows画图貌似就这么干的）。</p>
<table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFDB，标识码</td>
</tr>
<tr>
<td>0x02</td>
<td>2</td>
<td>本段除标识码外的字节数</td>
</tr>
<tr>
<td>0x04</td>
<td>1</td>
<td>高4位表示精度（0：8位，1：16位），低4位表示表ID（0~3）</td>
</tr>
<tr>
<td>0x05</td>
<td>64或128</td>
<td>量化表</td>
</tr>
</tbody></table>
<p>最后两个字段可以多次出现。</p>
<h3 id="4-帧图像头（SOFO）"><a href="#4-帧图像头（SOFO）" class="headerlink" title="4. 帧图像头（SOFO）"></a>4. 帧图像头（SOFO）</h3><table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFC0，标识码</td>
</tr>
<tr>
<td>0x02</td>
<td>2</td>
<td>本段除标识码外的字节数</td>
</tr>
<tr>
<td>0x04</td>
<td>1</td>
<td>一般为8，表示样本位数</td>
</tr>
<tr>
<td>0x05</td>
<td>2</td>
<td>图像高度</td>
</tr>
<tr>
<td>0x07</td>
<td>2</td>
<td>图像宽度</td>
</tr>
<tr>
<td>0x09</td>
<td>1</td>
<td>颜色分量数，必须为3</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（以下3个字段需要重复3次，表示3种颜色分量）</td>
</tr>
<tr>
<td>0x10</td>
<td>1</td>
<td>颜色分量ID（从1开始）</td>
</tr>
<tr>
<td>0x11</td>
<td>1</td>
<td>高4位水平采样因子，低4位垂直采样因子（Y应该都是2，UV应该都是1）</td>
</tr>
<tr>
<td>0x12</td>
<td>1</td>
<td>该分量使用的量化表ID</td>
</tr>
</tbody></table>
<h3 id="5-Huffman表（DHT）"><a href="#5-Huffman表（DHT）" class="headerlink" title="5. Huffman表（DHT）"></a>5. Huffman表（DHT）</h3><p>这个和量化表一样，一个DHT可以有多个Huffman表，或者也可以有多个DHT段。</p>
<table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFC4，标识码</td>
</tr>
<tr>
<td>0x02</td>
<td>2</td>
<td>本段除标识码外的字节数</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（以下3字段可以出现多次）</td>
</tr>
<tr>
<td>0x04</td>
<td>1</td>
<td>高4位为类型（0为直流，1为交流），低4位为表ID（0或1）</td>
</tr>
<tr>
<td>0x05</td>
<td>16</td>
<td>分别表示长度为1~16的Huffman编码各有多少</td>
</tr>
<tr>
<td>0x15</td>
<td>不定</td>
<td>要进行Huffman编码的字节们，按照长度由短到长排序</td>
</tr>
</tbody></table>
<p>在这里我不得不说一下JPEG中诡异的Huffman存储方式，通过上面的两个字段我们知道了每个字节的Huffman长度，然后我需要这样构造编码：第一个元素是全0，由上一个元素转移到下一个元素时，Huffman码要+1，如果长度不够就在最后补0。这样造出来的Huffman树是满足左子树的叶子深度不超过右子树的。</p>
<p>那么为什么Huffman编码的都是字节呢？是这样的，直流的$len$​当然是一个字节，交流的$x/len$​要把$x$​放到高8位，如果$x&gt;15$​，那么我们需要在前面放$(15/0,0)$表示连续的16个0​，这样所有的$x$​都是不超过0xF的。</p>
<h3 id="6-扫描头（SOS）"><a href="#6-扫描头（SOS）" class="headerlink" title="6. 扫描头（SOS）"></a>6. 扫描头（SOS）</h3><table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFDA，标识码</td>
</tr>
<tr>
<td>0x02</td>
<td>2</td>
<td>本段除标识码外的字节数</td>
</tr>
<tr>
<td>0x04</td>
<td>1</td>
<td>颜色分量数目，3</td>
</tr>
<tr>
<td></td>
<td></td>
<td>（以下2个字段重复3次）</td>
</tr>
<tr>
<td>0x05</td>
<td>1</td>
<td>颜色分量ID</td>
</tr>
<tr>
<td>0x06</td>
<td>1</td>
<td>高4位为直流Huffman表ID，低4位为交流Huffman表ID</td>
</tr>
<tr>
<td>0x0A</td>
<td>3</td>
<td>固定值0x003F00</td>
</tr>
</tbody></table>
<h3 id="7-图像压缩数据"><a href="#7-图像压缩数据" class="headerlink" title="7. 图像压缩数据"></a>7. 图像压缩数据</h3><p>紧接在SOS段之后，这一大串二进制序列从第一个字节的<strong>最高位</strong>开始一直到最后一个字节。</p>
<p>在这个序列中，被压缩后的矩阵的排列方式是这样的，首先将图像划分为若干$16×16$​子矩阵，每个子矩阵里有4个Y分量的$8×8$子矩阵，U和V分量的$8×8$子矩阵各一个，如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/h5aB8g"><img src="https://z3.ax1x.com/2021/09/06/h5aB8g.png" alt="h5aB8g.png"></a></p>
<p>我们在最终编码时，把这些$16×16$子矩阵视作一个基本单位，基本单位的顺序就是一行一行的来，而基本单位内部是6个$8×8$子矩阵的编码，它们的顺序是$Y_1,Y_2,Y_3,Y_4,U,V$，<strong>注意：直流系数差分的顺序就是相同分量的子矩阵在最终的矩阵序列中的出现顺序！</strong></p>
<h3 id="8-文件结尾（EOI）"><a href="#8-文件结尾（EOI）" class="headerlink" title="8. 文件结尾（EOI）"></a>8. 文件结尾（EOI）</h3><table>
<thead>
<tr>
<th>偏移</th>
<th>字节数</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>0x00</td>
<td>2</td>
<td>0xFFD9，图像结束</td>
</tr>
</tbody></table>
<hr>
<hr>
<p>以下是我花了4天时间写的一个JPEG编码/解码示例程序，写起来真的比较恶心，而且还存在着两个我无法解决或解释的问题：</p>
<p>①不知道为什么，我在解码最后需要对颜色值进行一个<code>r+=295; g-=18; b+=343;</code>的变换才能显示出正常图像，而且这3个神秘的常数对于所有图像都是成立的，编码时也需要在最开始倒着来一遍。</p>
<p>②大概是我对于颜色变换的中间某一步的理解出现了些许偏差，我编码后的jpg图像虽然跟原图差不多，但在正常的图像查看软件上会存在网格纹的干扰，但是我用自己的解码器显示就十分正常，而且解码器显示画图保存的jpg也会在颜色细节上有一些不好的地方，应该是编码器和解码器在相同的地方都出了点偏差。</p>
<p>code：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br></pre></td><td class="code"><pre><span class="line">COLORREF cols[N][N]; <span class="comment">//用来保存位图的颜色值，属于Encode的输入，Decode的输出</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> PI=<span class="built_in">acos</span>(<span class="number">-1</span>);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Matrix</span>&#123;</span></span><br><span class="line">    <span class="keyword">double</span> v[<span class="number">8</span>][<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    Matrix(<span class="keyword">int</span> _n) &#123;  <span class="built_in">memset</span>(v,<span class="number">0</span>,<span class="keyword">sizeof</span>(v)); n=_n;  &#125;</span><br><span class="line">    <span class="keyword">friend</span> Matrix <span class="keyword">operator</span> *(<span class="keyword">const</span> Matrix &amp;a,<span class="keyword">const</span> Matrix &amp;b)&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">c</span><span class="params">(a.n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;a.n;i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;a.n;k++)</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;a.n;j++) c.v[i][j]+=a.v[i][k]*b.v[k][j];</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Matrix <span class="title">Inv</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">double</span> me[<span class="number">8</span>][<span class="number">8</span>],res[<span class="number">8</span>][<span class="number">8</span>];</span><br><span class="line">        <span class="built_in">memset</span>(res,<span class="number">0</span>,<span class="keyword">sizeof</span>(res)); <span class="built_in">memcpy</span>(me,v,<span class="keyword">sizeof</span>(v));</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++) res[i][i]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> lst=<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=i;j&lt;n;j++) <span class="keyword">if</span>(<span class="built_in">fabs</span>(me[j][i])&gt;<span class="number">1e-7</span>) lst=j;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++) swap(me[i][j],me[lst][j]),swap(res[i][j],res[lst][j]);</span><br><span class="line">            <span class="keyword">double</span> dk=me[i][i];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++) me[i][j]/=dk,res[i][j]/=dk;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(j==i) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">double</span> x=me[j][i];</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;n;k++) me[j][k]-=x*me[i][k],res[j][k]-=x*res[i][k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Matrix <span class="title">c</span><span class="params">(n)</span></span>; <span class="built_in">memcpy</span>(c.v,res,<span class="keyword">sizeof</span>(res)); <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Matrix <span class="title">DCT</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">dct</span><span class="params">(<span class="number">8</span>)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(i==<span class="number">0</span>) dct.v[i][j]=<span class="number">1</span>/<span class="built_in">sqrt</span>(<span class="number">8</span>);</span><br><span class="line">                <span class="keyword">else</span> dct.v[i][j]=<span class="built_in">cos</span>(PI*(<span class="number">2</span>*j+<span class="number">1</span>)*i/<span class="number">16</span>)/<span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> dct;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Matrix <span class="title">YUV</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">yuv</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">        yuv.v[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">0.299</span>; yuv.v[<span class="number">0</span>][<span class="number">1</span>]=<span class="number">0.578</span>; yuv.v[<span class="number">0</span>][<span class="number">2</span>]=<span class="number">0.114</span>;</span><br><span class="line">        yuv.v[<span class="number">1</span>][<span class="number">0</span>]=<span class="number">-0.1687</span>; yuv.v[<span class="number">1</span>][<span class="number">1</span>]=<span class="number">-0.3313</span>; yuv.v[<span class="number">1</span>][<span class="number">2</span>]=<span class="number">0.5</span>;</span><br><span class="line">        yuv.v[<span class="number">2</span>][<span class="number">0</span>]=<span class="number">0.5</span>; yuv.v[<span class="number">2</span>][<span class="number">1</span>]=<span class="number">-0.4187</span>; yuv.v[<span class="number">2</span>][<span class="number">2</span>]=<span class="number">-0.0813</span>;</span><br><span class="line">        <span class="keyword">return</span> yuv;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">Matrix <span class="title">T</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="function">Matrix <span class="title">c</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;n;j++) c.v[i][j]=v[j][i];</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">int</span> realheight,realwidth; <span class="comment">//图像的宽度和高度，属于Encode的输入和Decode的输出</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">10000000</span>];</span><br><span class="line"><span class="keyword">double</span> val[<span class="number">3</span>][N][N];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">BitIterator</span>&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> **p;</span><br><span class="line">    <span class="keyword">int</span> *pos;</span><br><span class="line">    BitIterator(<span class="keyword">unsigned</span> <span class="keyword">char</span> *ptr)&#123;</span><br><span class="line">        p=<span class="keyword">new</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>*; *p=ptr;</span><br><span class="line">        pos=<span class="keyword">new</span> <span class="keyword">int</span>; *pos=<span class="number">7</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">Next</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x=((*(*p))&gt;&gt;(*pos))&amp;<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(*pos==<span class="number">0</span>)&#123;</span><br><span class="line">            *pos=<span class="number">7</span>;</span><br><span class="line">            <span class="keyword">if</span>(*(*p)==<span class="number">0xff</span>) (*p)++;</span><br><span class="line">            (*p)++;</span><br><span class="line">        &#125;<span class="keyword">else</span> (*pos)--;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">GetVal</span><span class="params">(<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!len) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> x=<span class="number">0</span>; <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++) x=(x&lt;&lt;<span class="number">1</span>)|Next();</span><br><span class="line">        <span class="keyword">if</span>(x&gt;=(<span class="number">1</span>&lt;&lt;(len<span class="number">-1</span>))) <span class="keyword">return</span> x;</span><br><span class="line">        <span class="keyword">return</span> x-(<span class="number">1</span>&lt;&lt;len)+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WriteByte</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> byte)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(*pos!=<span class="number">7</span>) (*p)++,*pos=<span class="number">7</span>;</span><br><span class="line">        *(*p)=byte; (*p)++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Out</span><span class="params">(<span class="keyword">int</span> bit)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(*pos==<span class="number">7</span>) *(*p)=<span class="number">0</span>;</span><br><span class="line">        *(*p)|=(bit&lt;&lt;(*pos));</span><br><span class="line">        <span class="keyword">if</span>(*pos==<span class="number">0</span>)&#123;</span><br><span class="line">            *pos=<span class="number">7</span>;</span><br><span class="line">            <span class="keyword">if</span>(*(*p)==<span class="number">0xff</span>) (*p)++,*(*p)=<span class="number">0</span>;</span><br><span class="line">            (*p)++;</span><br><span class="line">        &#125;<span class="keyword">else</span> (*pos)--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OutVal</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> len)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(x&lt;<span class="number">0</span>) x=(<span class="number">1</span>&lt;&lt;len)+x<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=len<span class="number">-1</span>;i&gt;=<span class="number">0</span>;i--) Out((x&gt;&gt;i)&amp;<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">calc</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> ans=<span class="number">0</span>; <span class="keyword">while</span>(x) x&gt;&gt;=<span class="number">1</span>,ans++; <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Huffman</span>&#123;</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; ch[<span class="number">2</span>],val,vec;</span><br><span class="line">    <span class="keyword">int</span> cnt[<span class="number">17</span>];</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; mp_len,mp_code;</span><br><span class="line">    Huffman()&#123;</span><br><span class="line">        ch[<span class="number">0</span>].clear(); ch[<span class="number">1</span>].clear(); val.clear();</span><br><span class="line">        ch[<span class="number">0</span>].push_back(<span class="number">0</span>); ch[<span class="number">1</span>].push_back(<span class="number">0</span>); val.push_back(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">n</span>&#123;</span></span><br><span class="line">        <span class="keyword">int</span> cnt; <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">        <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt;(_n a,_n b) &#123; <span class="keyword">return</span> a.cnt&gt;b.cnt; &#125;</span><br><span class="line">    &#125;node;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> pt,<span class="keyword">int</span> deep,<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!ch[<span class="number">0</span>][pt]&amp;&amp;!ch[<span class="number">1</span>][pt]) mp_len[val[pt]]=deep,mp_code[val[pt]]=x; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(ch[<span class="number">0</span>][pt]) dfs(ch[<span class="number">0</span>][pt],deep+<span class="number">1</span>,x&lt;&lt;<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(ch[<span class="number">1</span>][pt]) dfs(ch[<span class="number">1</span>][pt],deep+<span class="number">1</span>,(x&lt;&lt;<span class="number">1</span>)|<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Build</span><span class="params">(<span class="built_in">map</span>&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; &amp;mp)</span></span>&#123;</span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">auto</span> i:mp) vec.push_back(i.first);</span><br><span class="line">         <span class="built_in">memset</span>(cnt,<span class="number">0</span>,<span class="keyword">sizeof</span>(cnt));</span><br><span class="line">         <span class="keyword">if</span>(mp.size()==<span class="number">12</span>)&#123;</span><br><span class="line">             cnt[<span class="number">1</span>]=<span class="number">0</span>; cnt[<span class="number">2</span>]=<span class="number">1</span>; cnt[<span class="number">3</span>]=<span class="number">5</span>; cnt[<span class="number">4</span>]=<span class="number">1</span>; cnt[<span class="number">5</span>]=<span class="number">1</span>; cnt[<span class="number">6</span>]=<span class="number">1</span>; cnt[<span class="number">7</span>]=<span class="number">1</span>;</span><br><span class="line">             cnt[<span class="number">8</span>]=<span class="number">1</span>; cnt[<span class="number">9</span>]=<span class="number">1</span>;</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">             cnt[<span class="number">2</span>]=<span class="number">2</span>; cnt[<span class="number">3</span>]=<span class="number">1</span>; cnt[<span class="number">4</span>]=<span class="number">3</span>; cnt[<span class="number">5</span>]=<span class="number">3</span>; cnt[<span class="number">6</span>]=<span class="number">2</span>; cnt[<span class="number">7</span>]=<span class="number">4</span>; cnt[<span class="number">8</span>]=<span class="number">3</span>;</span><br><span class="line">             cnt[<span class="number">9</span>]=<span class="number">5</span>; cnt[<span class="number">10</span>]=<span class="number">5</span>; cnt[<span class="number">11</span>]=<span class="number">4</span>; cnt[<span class="number">12</span>]=<span class="number">4</span>; cnt[<span class="number">15</span>]=<span class="number">1</span>; cnt[<span class="number">16</span>]=<span class="number">0x7d</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         sort(vec.begin(),vec.end(),[&amp;mp](<span class="keyword">int</span> a,<span class="keyword">int</span> b)-&gt;<span class="keyword">bool</span>&#123;</span><br><span class="line">             <span class="keyword">return</span> mp[a]&gt;mp[b];</span><br><span class="line">             &#125;);</span><br><span class="line">         <span class="keyword">int</span> lst=<span class="number">-1</span>,lstlen=<span class="number">-1</span>;</span><br><span class="line">         <span class="keyword">int</span> ptr=<span class="number">1</span>,tot=<span class="number">0</span>;</span><br><span class="line">         <span class="keyword">for</span>(<span class="keyword">int</span> i:vec)&#123;</span><br><span class="line">             <span class="keyword">while</span>(tot==cnt[ptr]) tot=<span class="number">0</span>,ptr++;</span><br><span class="line">             <span class="keyword">if</span>(lst==<span class="number">-1</span>) lst=<span class="number">0</span>,lstlen=ptr; <span class="keyword">else</span>&#123;</span><br><span class="line">                 lst++; lst&lt;&lt;=(ptr-max(calc(lst),lstlen)); lstlen=ptr;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="built_in">wstring</span> str;</span><br><span class="line">             <span class="keyword">for</span>(<span class="keyword">int</span> j=lstlen<span class="number">-1</span>;j&gt;=<span class="number">0</span>;j--) str.push_back(<span class="string">L&#x27;0&#x27;</span>+((lst&gt;&gt;j)&amp;<span class="number">1</span>));</span><br><span class="line">             Insert(str,i);</span><br><span class="line">             tot++;</span><br><span class="line">         &#125;</span><br><span class="line">         dfs(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Insert</span><span class="params">(<span class="built_in">wstring</span> str,<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cur=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;str.length();i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!ch[str[i]-<span class="string">&#x27;0&#x27;</span>][cur]) ch[str[i]-<span class="string">&#x27;0&#x27;</span>][cur]=val.size(),ch[<span class="number">0</span>].push_back(<span class="number">0</span>),ch[<span class="number">1</span>].push_back(<span class="number">0</span>),val.push_back(<span class="number">0</span>);</span><br><span class="line">            cur=ch[str[i]-<span class="string">&#x27;0&#x27;</span>][cur];</span><br><span class="line">        &#125;</span><br><span class="line">        val[cur]=x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">Read</span><span class="params">(BitIterator it)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> cur=<span class="number">0</span>; </span><br><span class="line">        <span class="keyword">while</span>(ch[<span class="number">0</span>][cur]||ch[<span class="number">1</span>][cur])&#123;</span><br><span class="line">            cur=ch[it.Next()][cur];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> val[cur];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">get16</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *p)</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> x=*p; <span class="keyword">return</span> (x&lt;&lt;<span class="number">8</span>)|(*(p+<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write16</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *p,<span class="keyword">unsigned</span> <span class="keyword">short</span> x)</span></span>&#123;</span><br><span class="line">    *p=((x&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xff</span>); *(p+<span class="number">1</span>)=x&amp;<span class="number">0xff</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Move</span><span class="params">(<span class="keyword">int</span> &amp;x,<span class="keyword">int</span> &amp;y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>((x+y)&amp;<span class="number">1</span>)&#123; <span class="comment">// down left</span></span><br><span class="line">        <span class="keyword">if</span>(x<span class="number">-1</span>&gt;=<span class="number">0</span>&amp;&amp;y+<span class="number">1</span>&lt;<span class="number">8</span>) x--,y++; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(x==<span class="number">0</span>) y++; <span class="keyword">else</span> x++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// up right</span></span><br><span class="line">        <span class="keyword">if</span>(x+<span class="number">1</span>&lt;<span class="number">8</span>&amp;&amp;y<span class="number">-1</span>&gt;=<span class="number">0</span>) x++,y--; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(x==<span class="number">7</span>) y++; <span class="keyword">else</span> x++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Matrix <span class="title">GetData</span><span class="params">(BitIterator it,Huffman &amp;huf_dc,Huffman &amp;huf_ac)</span></span>&#123;</span><br><span class="line">    <span class="function">Matrix <span class="title">res</span><span class="params">(<span class="number">8</span>)</span></span>;</span><br><span class="line">    <span class="keyword">int</span> x=<span class="number">0</span>,y=<span class="number">0</span>;</span><br><span class="line">    res.v[<span class="number">0</span>][<span class="number">0</span>]=it.GetVal(huf_dc.Read(it));</span><br><span class="line">    Move(x,y);</span><br><span class="line">    <span class="keyword">int</span> ptr=<span class="number">1</span>; <span class="keyword">while</span>(ptr&lt;<span class="number">64</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> head=huf_ac.Read(it);</span><br><span class="line">        <span class="keyword">if</span>(head==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(ptr&lt;<span class="number">64</span>) res.v[y][x]=<span class="number">0</span>,Move(x,y),ptr++;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> len0=(head&gt;&gt;<span class="number">4</span>)&amp;<span class="number">0xf</span>,lenx=head&amp;<span class="number">0xf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len0;i++) res.v[y][x]=<span class="number">0</span>,Move(x,y),ptr++;</span><br><span class="line">        res.v[y][x]=it.GetVal(lenx); Move(x,y); ptr++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *ptr)</span></span>&#123; <span class="comment">//change realheight,realwidth,cols</span></span><br><span class="line">    Matrix dct=Matrix::DCT().Inv(),dctT=dct.T();</span><br><span class="line">    Matrix yuv=Matrix::YUV().Inv();</span><br><span class="line">    Huffman ht[<span class="number">2</span>][<span class="number">2</span>]; <span class="comment">//[dc/ac][id]</span></span><br><span class="line">    <span class="keyword">int</span> tab[<span class="number">4</span>][<span class="number">8</span>][<span class="number">8</span>]; <span class="built_in">memset</span>(tab,<span class="number">0</span>,<span class="keyword">sizeof</span>(tab));</span><br><span class="line">    <span class="keyword">int</span> used_tab[<span class="number">4</span>],id[<span class="number">4</span>],x_sample[<span class="number">4</span>],y_sample[<span class="number">4</span>];</span><br><span class="line">    ptr+=<span class="number">2</span>; <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(*(ptr+<span class="number">1</span>)==<span class="number">0xDB</span>)&#123; <span class="comment">// div table</span></span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *dest=ptr+<span class="number">2</span>+get16(ptr+<span class="number">2</span>);</span><br><span class="line">            ptr+=<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(ptr&lt;dest)&#123;</span><br><span class="line">                <span class="keyword">unsigned</span> <span class="keyword">char</span> x=*ptr; ptr++;</span><br><span class="line">                <span class="keyword">int</span> len=<span class="number">1</span>+((x&gt;&gt;<span class="number">4</span>)&amp;<span class="number">0xf</span>),id=x&amp;<span class="number">0xf</span>; </span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(len==<span class="number">1</span>) tab[id][i][j]=*ptr; <span class="keyword">else</span> tab[id][i][j]=get16(ptr);</span><br><span class="line">                        ptr+=len;</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125; <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(*(ptr+<span class="number">1</span>)==<span class="number">0xc0</span>)&#123; <span class="comment">// info header</span></span><br><span class="line">            realheight=get16(ptr+<span class="number">5</span>);</span><br><span class="line">            realwidth=get16(ptr+<span class="number">7</span>);</span><br><span class="line">            ptr+=<span class="number">10</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++,ptr+=<span class="number">3</span>)&#123;</span><br><span class="line">                id[i]=*ptr; x_sample[i]=((*(ptr+<span class="number">1</span>))&gt;&gt;<span class="number">4</span>)&amp;<span class="number">0xf</span>;</span><br><span class="line">                y_sample[i]=(*(ptr+<span class="number">1</span>))&amp;<span class="number">0xf</span>; used_tab[i]=*(ptr+<span class="number">2</span>);</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(*(ptr+<span class="number">1</span>)==<span class="number">0xc4</span>)&#123; <span class="comment">// Huffman Table</span></span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *dest=ptr+<span class="number">2</span>+get16(ptr+<span class="number">2</span>);</span><br><span class="line">            ptr+=<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(ptr&lt;dest)&#123;</span><br><span class="line">                <span class="keyword">int</span> cnt[<span class="number">17</span>]; <span class="built_in">memset</span>(cnt,<span class="number">0</span>,<span class="keyword">sizeof</span>(cnt));</span><br><span class="line">                <span class="keyword">int</span> dc_ac=((*ptr)&gt;&gt;<span class="number">4</span>)&amp;<span class="number">0xf</span>,id=(*ptr)&amp;<span class="number">0xf</span>; ptr++;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">16</span>;i++,ptr++) cnt[i]=*ptr;</span><br><span class="line">                <span class="keyword">int</span> lst=<span class="number">-1</span>,lstlen=<span class="number">-1</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=<span class="number">16</span>;i++)&#123;</span><br><span class="line">                    <span class="keyword">while</span>(cnt[i])&#123;</span><br><span class="line">                        <span class="keyword">if</span>(lst==<span class="number">-1</span>) lstlen=i,lst=<span class="number">0</span>; <span class="keyword">else</span>&#123;</span><br><span class="line">                            lst++; <span class="keyword">if</span>(i&gt;lstlen) lst&lt;&lt;=(i-max(lstlen,calc(lst))),lstlen=i;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">wstring</span> str; <span class="keyword">int</span> x=lst;</span><br><span class="line">                        <span class="keyword">if</span>(!x) str=<span class="string">L&quot;0&quot;</span>;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">while</span>(x) str.push_back(x%<span class="number">2</span>+<span class="string">L&#x27;0&#x27;</span>),x&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">while</span>(str.length()&lt;i) str.push_back(<span class="string">L&#x27;0&#x27;</span>);</span><br><span class="line">                        reverse(str.begin(),str.end());</span><br><span class="line">                        ht[dc_ac][id].Insert(str,*ptr);</span><br><span class="line">                        ptr++; cnt[i]--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(*(ptr+<span class="number">1</span>)==<span class="number">0xda</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> dc_id[<span class="number">4</span>],ac_id[<span class="number">4</span>];</span><br><span class="line">            ptr+=<span class="number">5</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++,ptr+=<span class="number">2</span>)&#123;</span><br><span class="line">                dc_id[i]=((*(ptr+<span class="number">1</span>))&gt;&gt;<span class="number">4</span>)&amp;<span class="number">0xf</span>;</span><br><span class="line">                ac_id[i]=(*(ptr+<span class="number">1</span>))&amp;<span class="number">0xf</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ptr+=<span class="number">3</span>;</span><br><span class="line">            <span class="function">BitIterator <span class="title">it</span><span class="params">(ptr)</span></span>;</span><br><span class="line">            <span class="keyword">int</span> height=(realheight/<span class="number">16</span>+(realheight%<span class="number">16</span>!=<span class="number">0</span>))*<span class="number">16</span>;</span><br><span class="line">            <span class="keyword">int</span> width=(realwidth/<span class="number">16</span>+(realwidth%<span class="number">16</span>!=<span class="number">0</span>))*<span class="number">16</span>;</span><br><span class="line">            <span class="keyword">double</span> dCr=<span class="number">0</span>,dCv=<span class="number">0</span>,dY=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>;y&lt;height;y+=<span class="number">16</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>;x&lt;width;x+=<span class="number">16</span>)&#123;</span><br><span class="line">                    Matrix Y1=GetData(it,ht[<span class="number">0</span>][dc_id[<span class="number">0</span>]],ht[<span class="number">1</span>][ac_id[<span class="number">0</span>]]);</span><br><span class="line">                    dY+=Y1.v[<span class="number">0</span>][<span class="number">0</span>]; Y1.v[<span class="number">0</span>][<span class="number">0</span>]=dY;</span><br><span class="line">                    Matrix Y2=GetData(it,ht[<span class="number">0</span>][dc_id[<span class="number">0</span>]],ht[<span class="number">1</span>][ac_id[<span class="number">0</span>]]);</span><br><span class="line">                    dY+=Y2.v[<span class="number">0</span>][<span class="number">0</span>]; Y2.v[<span class="number">0</span>][<span class="number">0</span>]=dY;</span><br><span class="line">                    Matrix Y3=GetData(it,ht[<span class="number">0</span>][dc_id[<span class="number">0</span>]],ht[<span class="number">1</span>][ac_id[<span class="number">0</span>]]);</span><br><span class="line">                    dY+=Y3.v[<span class="number">0</span>][<span class="number">0</span>]; Y3.v[<span class="number">0</span>][<span class="number">0</span>]=dY;</span><br><span class="line">                    Matrix Y4=GetData(it,ht[<span class="number">0</span>][dc_id[<span class="number">0</span>]],ht[<span class="number">1</span>][ac_id[<span class="number">0</span>]]);</span><br><span class="line">                    dY+=Y4.v[<span class="number">0</span>][<span class="number">0</span>]; Y4.v[<span class="number">0</span>][<span class="number">0</span>]=dY;</span><br><span class="line">                    Matrix Cr=GetData(it,ht[<span class="number">0</span>][dc_id[<span class="number">1</span>]],ht[<span class="number">1</span>][ac_id[<span class="number">1</span>]]);</span><br><span class="line">                    Matrix Cv=GetData(it,ht[<span class="number">0</span>][dc_id[<span class="number">2</span>]],ht[<span class="number">1</span>][ac_id[<span class="number">2</span>]]);</span><br><span class="line">                    dCr+=Cr.v[<span class="number">0</span>][<span class="number">0</span>]; dCv+=Cv.v[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">                    Cr.v[<span class="number">0</span>][<span class="number">0</span>]=dCr; Cv.v[<span class="number">0</span>][<span class="number">0</span>]=dCv;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++) </span><br><span class="line">                            Cr.v[i][j]*=tab[used_tab[<span class="number">1</span>]][i][j],Cv.v[i][j]*=tab[used_tab[<span class="number">2</span>]][i][j];</span><br><span class="line">                    &#125;</span><br><span class="line">                    Cr=dct*Cr*dctT; Cv=dct*Cv*dctT;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                            val[<span class="number">0</span>][y+i][x+j]=Y1.v[i][j];</span><br><span class="line">                            val[<span class="number">0</span>][y+<span class="number">8</span>+i][x+j]=Y3.v[i][j];</span><br><span class="line">                            val[<span class="number">0</span>][y+i][x+<span class="number">8</span>+j]=Y2.v[i][j];</span><br><span class="line">                            val[<span class="number">0</span>][y+<span class="number">8</span>+i][x+<span class="number">8</span>+j]=Y4.v[i][j];</span><br><span class="line">                            <span class="keyword">for</span>(<span class="keyword">int</span> a=<span class="number">0</span>;a&lt;<span class="number">2</span>;a++)&#123;</span><br><span class="line">                                <span class="keyword">for</span>(<span class="keyword">int</span> b=<span class="number">0</span>;b&lt;<span class="number">2</span>;b++)&#123;</span><br><span class="line">                                    val[<span class="number">1</span>][y+i*<span class="number">2</span>+a][x+j*<span class="number">2</span>+b]=Cr.v[i][j];</span><br><span class="line">                                    val[<span class="number">2</span>][y+i*<span class="number">2</span>+a][x+j*<span class="number">2</span>+b]=Cv.v[i][j];</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>;y&lt;height;y+=<span class="number">8</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>;x&lt;width;x+=<span class="number">8</span>)&#123;</span><br><span class="line">                    <span class="function">Matrix <span class="title">Y</span><span class="params">(<span class="number">8</span>)</span></span>;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++) Y.v[i][j]=val[<span class="number">0</span>][y+i][x+j]*tab[used_tab[<span class="number">0</span>]][i][j];</span><br><span class="line">                    Y=dct*Y*dctT;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">                        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++) val[<span class="number">0</span>][y+i][x+j]=Y.v[i][j];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;realheight;i++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;realwidth;j++)&#123;</span><br><span class="line">                    val[<span class="number">1</span>][i][j]-=<span class="number">128</span>; val[<span class="number">2</span>][i][j]-=<span class="number">128</span>;</span><br><span class="line">                    <span class="keyword">int</span> r=yuv.v[<span class="number">0</span>][<span class="number">0</span>]*val[<span class="number">0</span>][i][j]+yuv.v[<span class="number">0</span>][<span class="number">1</span>]*val[<span class="number">1</span>][i][j]+yuv.v[<span class="number">0</span>][<span class="number">2</span>]*val[<span class="number">2</span>][i][j];</span><br><span class="line">                    <span class="keyword">int</span> g=yuv.v[<span class="number">1</span>][<span class="number">0</span>]*val[<span class="number">0</span>][i][j]+yuv.v[<span class="number">1</span>][<span class="number">1</span>]*val[<span class="number">1</span>][i][j]+yuv.v[<span class="number">1</span>][<span class="number">2</span>]*val[<span class="number">2</span>][i][j];</span><br><span class="line">                    <span class="keyword">int</span> b=yuv.v[<span class="number">2</span>][<span class="number">0</span>]*val[<span class="number">0</span>][i][j]+yuv.v[<span class="number">2</span>][<span class="number">1</span>]*val[<span class="number">1</span>][i][j]+yuv.v[<span class="number">2</span>][<span class="number">2</span>]*val[<span class="number">2</span>][i][j];</span><br><span class="line">                    r+=<span class="number">295</span>; g-=<span class="number">18</span>; b+=<span class="number">343</span>;</span><br><span class="line">                    r=min(<span class="number">255</span>,max(<span class="number">0</span>,r)); g=min(<span class="number">255</span>,max(<span class="number">0</span>,g)); b=min(<span class="number">255</span>,max(<span class="number">0</span>,b));</span><br><span class="line">                    cols[i][j]=RGB(r,g,b);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ptr+=(<span class="number">2</span>+get16(ptr+<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">IntMatrix</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> v[<span class="number">8</span>][<span class="number">8</span>];</span><br><span class="line">&#125;;</span><br><span class="line">IntMatrix Ys[N/<span class="number">8</span>][N/<span class="number">8</span>],Us[N/<span class="number">16</span>][N/<span class="number">16</span>],Vs[N/<span class="number">16</span>][N/<span class="number">16</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> head;</span><br><span class="line">    <span class="keyword">int</span> x,len;</span><br><span class="line">    <span class="keyword">bool</span> isac;</span><br><span class="line">    <span class="keyword">bool</span> htid;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">D</span><span class="params">(<span class="keyword">int</span> &amp;source,<span class="keyword">int</span> dx)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rest=source; source-=dx; <span class="keyword">return</span> rest;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetLen</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="keyword">if</span>(x&lt;<span class="number">0</span>) x=-x;</span><br><span class="line">    <span class="keyword">int</span> ans=<span class="number">0</span>; <span class="keyword">while</span>(x) ans++,x&gt;&gt;=<span class="number">1</span>; <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PushMatrix</span><span class="params">(IntMatrix &amp;mat,<span class="built_in">vector</span>&lt;Node&gt; &amp;flow,<span class="keyword">int</span> htid)</span></span>&#123;</span><br><span class="line">    Node dc; dc.head=dc.len=GetLen(mat.v[<span class="number">0</span>][<span class="number">0</span>]); dc.isac=<span class="number">0</span>; dc.x=mat.v[<span class="number">0</span>][<span class="number">0</span>];</span><br><span class="line">    dc.htid=htid; flow.push_back(dc);</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">    <span class="keyword">int</span> x=<span class="number">0</span>,y=<span class="number">0</span>; Move(x,y);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;<span class="number">64</span>;i++) vec.push_back(mat.v[y][x]),Move(x,y);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;vec.size();i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> j=i; <span class="keyword">while</span>(j+<span class="number">1</span>&lt;vec.size()&amp;&amp;!vec[j]) j++;</span><br><span class="line">        <span class="keyword">if</span>(j+<span class="number">1</span>==vec.size()&amp;&amp;!vec[j])&#123;</span><br><span class="line">            Node ac; ac.head=ac.len=ac.x=<span class="number">0</span>; ac.isac=<span class="number">1</span>; ac.htid=htid; flow.push_back(ac); <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j=min(j,i+<span class="number">15</span>);</span><br><span class="line">        Node ac; ac.head=((j-i)&lt;&lt;<span class="number">4</span>)|GetLen(vec[j]); ac.len=GetLen(vec[j]);</span><br><span class="line">        ac.isac=<span class="number">1</span>; ac.htid=htid; ac.x=vec[j]; flow.push_back(ac);</span><br><span class="line">        i=j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *ptr)</span></span>&#123; <span class="comment">// use realheight,realwidth,cols[][], write jpeg flow in ptr</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *begin=ptr;</span><br><span class="line">    <span class="keyword">int</span> table[<span class="number">2</span>][<span class="number">8</span>][<span class="number">8</span>]=&#123;</span><br><span class="line">        &#123;</span><br><span class="line">        &#123;<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">4</span>,<span class="number">4</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">6</span>&#125;,</span><br><span class="line">        &#123;<span class="number">7</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">0xb</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">8</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xa</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">0xa</span>,<span class="number">0xd</span>,<span class="number">0xa</span>,<span class="number">0xa</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xb</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">7</span>,<span class="number">9</span>,<span class="number">0xe</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xf</span>,<span class="number">0xd</span>,<span class="number">0xc</span>,<span class="number">0xe</span>,<span class="number">0xb</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">        &#123;<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">3</span>&#125;,</span><br><span class="line">        &#123;<span class="number">3</span>,<span class="number">6</span>,<span class="number">0xc</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>,<span class="number">0xc</span>&#125;</span><br><span class="line">        &#125;   </span><br><span class="line">    &#125;;</span><br><span class="line">    *ptr=<span class="number">0xff</span>; ptr++; *ptr=<span class="number">0xd8</span>; ptr++;</span><br><span class="line">    *ptr=<span class="number">0xff</span>; ptr++; *ptr=<span class="number">0xe0</span>; ptr++; <span class="comment">//app0 block</span></span><br><span class="line">    write16(ptr,<span class="number">16</span>); ptr+=<span class="number">2</span>;</span><br><span class="line">    *ptr=<span class="number">0x4a</span>; ptr++; *ptr=<span class="number">0x46</span>; ptr++; *ptr=<span class="number">0x49</span>; ptr++; *ptr=<span class="number">0x46</span>; ptr++; *ptr=<span class="number">0</span>; ptr++; <span class="comment">//JFIF\0</span></span><br><span class="line">    *ptr=<span class="number">1</span>; ptr++; *ptr=<span class="number">2</span>; ptr++; <span class="comment">//ver</span></span><br><span class="line">    *ptr=<span class="number">1</span>; ptr++; <span class="comment">//1 pixel/inch</span></span><br><span class="line">    write16(ptr,<span class="number">120</span>); ptr+=<span class="number">2</span>; write16(ptr,<span class="number">120</span>); ptr+=<span class="number">2</span>; <span class="comment">//120dpi</span></span><br><span class="line">    *ptr=<span class="number">0</span>; ptr++; *ptr=<span class="number">0</span>; ptr++; <span class="comment">//no small image</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> op=<span class="number">0</span>;op&lt;<span class="number">2</span>;op++)&#123;</span><br><span class="line">        *ptr=<span class="number">0xff</span>; ptr++; *ptr=<span class="number">0xdb</span>; ptr++;</span><br><span class="line">        write16(ptr,<span class="number">67</span>); ptr+=<span class="number">2</span>;</span><br><span class="line">        *ptr=op; ptr++;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++) *ptr=table[op][i][j],ptr++;</span><br><span class="line">    &#125;</span><br><span class="line">    *ptr=<span class="number">0xff</span>; ptr++; *ptr=<span class="number">0xc0</span>; ptr++; <span class="comment">//SOFO block</span></span><br><span class="line">    write16(ptr,<span class="number">17</span>); ptr+=<span class="number">2</span>;</span><br><span class="line">    *ptr=<span class="number">8</span>; ptr++;</span><br><span class="line">    write16(ptr,realheight); ptr+=<span class="number">2</span>; write16(ptr,realwidth); ptr+=<span class="number">2</span>;</span><br><span class="line">    *ptr=<span class="number">3</span>; ptr++; <span class="comment">//YUV</span></span><br><span class="line">    *ptr=<span class="number">1</span>; ptr++; *ptr=<span class="number">0x22</span>; ptr++; *ptr=<span class="number">0</span>; ptr++; <span class="comment">// Y comp</span></span><br><span class="line">    *ptr=<span class="number">2</span>; ptr++; *ptr=<span class="number">0x11</span>; ptr++; *ptr=<span class="number">1</span>; ptr++; <span class="comment">// U comp</span></span><br><span class="line">    *ptr=<span class="number">3</span>; ptr++; *ptr=<span class="number">0x11</span>; ptr++; *ptr=<span class="number">1</span>; ptr++; <span class="comment">// V comp</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;Node&gt; vec;</span><br><span class="line">    <span class="keyword">int</span> height=(realheight/<span class="number">16</span>+(realheight%<span class="number">16</span>!=<span class="number">0</span>))*<span class="number">16</span>,width=(realwidth/<span class="number">16</span>+(realwidth%<span class="number">16</span>!=<span class="number">0</span>))*<span class="number">16</span>;</span><br><span class="line">    Matrix yuv=Matrix::YUV(),dct=Matrix::DCT(),dctT=dct.T();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>;y&lt;height;y+=<span class="number">8</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>;x&lt;width;x+=<span class="number">8</span>)&#123;</span><br><span class="line">            <span class="function">Matrix <span class="title">me</span><span class="params">(<span class="number">8</span>)</span></span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                    <span class="keyword">int</span> r=cols[y+i][x+j]&amp;<span class="number">255</span>,g=(cols[y+i][x+j]&gt;&gt;<span class="number">8</span>)&amp;<span class="number">255</span>,b=(cols[y+i][x+j]&gt;&gt;<span class="number">16</span>)&amp;<span class="number">255</span>;</span><br><span class="line">                    r-=<span class="number">295</span>; g+=<span class="number">18</span>; b-=<span class="number">343</span>; <span class="comment">//?</span></span><br><span class="line">                    me.v[i][j]=r*yuv.v[<span class="number">0</span>][<span class="number">0</span>]+g*yuv.v[<span class="number">0</span>][<span class="number">1</span>]+b*yuv.v[<span class="number">0</span>][<span class="number">2</span>];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            me=dct*me*dctT;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++) Ys[y/<span class="number">8</span>][x/<span class="number">8</span>].v[i][j]=round(me.v[i][j]/table[<span class="number">0</span>][i][j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> dY=<span class="number">0</span>,dU=<span class="number">0</span>,dV=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>;y&lt;height;y+=<span class="number">16</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>;x&lt;width;x+=<span class="number">16</span>)&#123;</span><br><span class="line">            Matrix rU(8),rV(8);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">16</span>;i++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">16</span>;j++)&#123;</span><br><span class="line">                    <span class="keyword">int</span> r=cols[y+i][x+j]&amp;<span class="number">255</span>,g=(cols[y+i][x+j]&gt;&gt;<span class="number">8</span>)&amp;<span class="number">255</span>,b=(cols[y+i][x+j]&gt;&gt;<span class="number">16</span>)&amp;<span class="number">255</span>;</span><br><span class="line">                    r-=<span class="number">295</span>; g+=<span class="number">18</span>; b-=<span class="number">343</span>; <span class="comment">//?</span></span><br><span class="line">                    rU.v[i/<span class="number">2</span>][j/<span class="number">2</span>]+=(<span class="number">128</span>+r*yuv.v[<span class="number">1</span>][<span class="number">0</span>]+g*yuv.v[<span class="number">1</span>][<span class="number">1</span>]+b*yuv.v[<span class="number">1</span>][<span class="number">2</span>]);</span><br><span class="line">                    rV.v[i/<span class="number">2</span>][j/<span class="number">2</span>]+=(<span class="number">128</span>+r*yuv.v[<span class="number">2</span>][<span class="number">0</span>]+g*yuv.v[<span class="number">2</span>][<span class="number">1</span>]+b*yuv.v[<span class="number">2</span>][<span class="number">2</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++) rU.v[i][j]/=<span class="number">4</span>,rV.v[i][j]/=<span class="number">4</span>;</span><br><span class="line">            rU=dct*rU*dctT; rV=dct*rV*dctT;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">8</span>;j++)&#123;</span><br><span class="line">                    Us[y/<span class="number">16</span>][x/<span class="number">16</span>].v[i][j]=round(rU.v[i][j]/table[<span class="number">1</span>][i][j]);</span><br><span class="line">                    Vs[y/<span class="number">16</span>][x/<span class="number">16</span>].v[i][j]=round(rV.v[i][j]/table[<span class="number">1</span>][i][j]);</span><br><span class="line">                &#125;</span><br><span class="line">            dY=D(Ys[y/<span class="number">8</span>][x/<span class="number">8</span>].v[<span class="number">0</span>][<span class="number">0</span>],dY);</span><br><span class="line">            dY=D(Ys[y/<span class="number">8</span>][x/<span class="number">8</span>+<span class="number">1</span>].v[<span class="number">0</span>][<span class="number">0</span>],dY);</span><br><span class="line">            dY=D(Ys[y/<span class="number">8</span>+<span class="number">1</span>][x/<span class="number">8</span>].v[<span class="number">0</span>][<span class="number">0</span>],dY);</span><br><span class="line">            dY=D(Ys[y/<span class="number">8</span>+<span class="number">1</span>][x/<span class="number">8</span>+<span class="number">1</span>].v[<span class="number">0</span>][<span class="number">0</span>],dY);</span><br><span class="line">            dU=D(Us[y/<span class="number">16</span>][x/<span class="number">16</span>].v[<span class="number">0</span>][<span class="number">0</span>],dU);</span><br><span class="line">            dV=D(Vs[y/<span class="number">16</span>][x/<span class="number">16</span>].v[<span class="number">0</span>][<span class="number">0</span>],dV);</span><br><span class="line">            PushMatrix(Ys[y/<span class="number">8</span>][x/<span class="number">8</span>],vec,<span class="number">0</span>); PushMatrix(Ys[y/<span class="number">8</span>][x/<span class="number">8</span>+<span class="number">1</span>],vec,<span class="number">0</span>);</span><br><span class="line">            PushMatrix(Ys[y/<span class="number">8</span>+<span class="number">1</span>][x/<span class="number">8</span>],vec,<span class="number">0</span>); PushMatrix(Ys[y/<span class="number">8</span>+<span class="number">1</span>][x/<span class="number">8</span>+<span class="number">1</span>],vec,<span class="number">0</span>);</span><br><span class="line">            PushMatrix(Us[y/<span class="number">16</span>][x/<span class="number">16</span>],vec,<span class="number">1</span>); PushMatrix(Vs[y/<span class="number">16</span>][x/<span class="number">16</span>],vec,<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">map</span>&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; cnt[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">11</span>;i++) cnt[<span class="number">0</span>][<span class="number">0</span>][i]=cnt[<span class="number">0</span>][<span class="number">1</span>][i]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">0xf</span>;i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">0xa</span>;j++) cnt[<span class="number">1</span>][<span class="number">0</span>][(i&lt;&lt;<span class="number">4</span>)|j]=cnt[<span class="number">1</span>][<span class="number">1</span>][(i&lt;&lt;<span class="number">4</span>)|j]=<span class="number">0</span>;</span><br><span class="line">    cnt[<span class="number">1</span>][<span class="number">0</span>][<span class="number">0</span>]=cnt[<span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">    cnt[<span class="number">1</span>][<span class="number">0</span>][<span class="number">0xf0</span>]=cnt[<span class="number">1</span>][<span class="number">1</span>][<span class="number">0xf0</span>]=<span class="number">0</span>;</span><br><span class="line">    Huffman ht[<span class="number">2</span>][<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;vec.size();i++)&#123;</span><br><span class="line">        cnt[vec[i].isac][vec[i].htid][vec[i].head]++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">2</span>;j++) ht[i][j].Build(cnt[i][j]);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">2</span>;j++)&#123;</span><br><span class="line">            *ptr=<span class="number">0xff</span>; ptr++; *ptr=<span class="number">0xc4</span>; ptr++;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *last=ptr;</span><br><span class="line">            ptr+=<span class="number">2</span>;</span><br><span class="line">            *ptr=(i&lt;&lt;<span class="number">4</span>)|j; ptr++;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">1</span>;k&lt;=<span class="number">16</span>;k++) *ptr=ht[i][j].cnt[k],ptr++;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;ht[i][j].vec.size();k++) *ptr=ht[i][j].vec[k],ptr++;</span><br><span class="line">            write16(last,ptr-last);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *ptr=<span class="number">0xff</span>; ptr++; *ptr=<span class="number">0xda</span>; ptr++; <span class="comment">// SOS block</span></span><br><span class="line">    write16(ptr,<span class="number">12</span>); ptr+=<span class="number">2</span>;</span><br><span class="line">    *ptr=<span class="number">3</span>; ptr++;</span><br><span class="line">    *ptr=<span class="number">1</span>; ptr++; *ptr=<span class="number">0</span>; ptr++;</span><br><span class="line">    *ptr=<span class="number">2</span>; ptr++; *ptr=<span class="number">0x11</span>; ptr++;</span><br><span class="line">    *ptr=<span class="number">3</span>; ptr++; *ptr=<span class="number">0x11</span>; ptr++;</span><br><span class="line">    *ptr=<span class="number">0</span>; ptr++; *ptr=<span class="number">0x3f</span>; ptr++; *ptr=<span class="number">0</span>; ptr++;</span><br><span class="line">    <span class="function">BitIterator <span class="title">it</span><span class="params">(ptr)</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;vec.size();i++)&#123;</span><br><span class="line">        <span class="keyword">int</span> len=ht[vec[i].isac][vec[i].htid].mp_len[vec[i].head];</span><br><span class="line">        <span class="keyword">int</span> code=ht[vec[i].isac][vec[i].htid].mp_code[vec[i].head];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j=len<span class="number">-1</span>;j&gt;=<span class="number">0</span>;j--) it.Out((code&gt;&gt;j)&amp;<span class="number">1</span>);</span><br><span class="line">        it.OutVal(vec[i].x,vec[i].len);</span><br><span class="line">    &#125;</span><br><span class="line">    it.WriteByte(<span class="number">0xff</span>); it.WriteByte(<span class="number">0xd9</span>);</span><br><span class="line">    <span class="keyword">return</span> (*it.p)-begin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.ywy-c-asm.cn/2021/09/06/JPEG%E5%9B%BE%E5%83%8F%E5%8E%8B%E7%BC%A9%E8%AF%A6%E8%A7%A3/" data-id="cl268xx750000bsz1cfhi15hl" data-title="JPEG图像压缩详解"></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">图像处理</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/04/09/%E6%95%B0%E5%AD%A6%E9%A2%98/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          两个生成函数毒瘤题
        
      </div>
    </a>
  
  
    <a href="/2021/06/26/CF1540B-Tree-Array/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CF1540B Tree Array</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ACM/" rel="tag">ACM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NLP/" rel="tag">NLP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA%E4%BB%8B%E7%BB%8D/" rel="tag">个人介绍</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" rel="tag">位运算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E5%AD%A6/" rel="tag">数学</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">friends</h3>
    <div class="widget">
      <li><a target="_blank" rel="noopener" href="https://blog.i207m.top/" title="i207M">i207M</a></li>
      <li><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/blog/ywycasm/" title="Old ywy_c_asm">Old ywy_c_asm</a></li>
      <li><a target="_blank" rel="noopener" href="https://blog.csdn.net/lyd_7_29" title="lyd729">lyd729</a></li>
      <li><a target="_blank" rel="noopener" href="https://www.shadowice1984.xyz/" title="shadowice1984">shadowice1984</a></li>
      <li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Miracevin" title="Miracle">Miracle</a></li>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/22/2022%E7%9C%81%E9%80%89/">2022年OI省选题选做</a>
          </li>
        
          <li>
            <a href="/2022/04/09/%E6%95%B0%E5%AD%A6%E9%A2%98/">两个生成函数毒瘤题</a>
          </li>
        
          <li>
            <a href="/2021/09/06/JPEG%E5%9B%BE%E5%83%8F%E5%8E%8B%E7%BC%A9%E8%AF%A6%E8%A7%A3/">JPEG图像压缩详解</a>
          </li>
        
          <li>
            <a href="/2021/06/26/CF1540B-Tree-Array/">CF1540B Tree Array</a>
          </li>
        
          <li>
            <a href="/2021/06/13/2021-06-13-2021-CCPC-%E4%B8%9C%E5%8C%97%E5%9B%9B%E7%9C%81%E8%B5%9B-%E8%B5%9B%E5%90%8E%E8%A1%A5%E9%A2%98/">2021 CCPC 东北四省赛 赛后补题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
	
<iframe id="iframe1" src="/balls3.html" style="height:500px;width:1500px;position:absolute;top:500px;left:0px;z-index:-1" scrolling="no" frameborder="0"></iframe>
		<script>
			var width=parseInt(document.body.clientWidth.toString().replace("px", ""), 10);
			var height=document.body.scrollHeight;
			iframe1.style='height:'+height+'px;width:'+width+'px;position:absolute;top:0px;left:0px;z-index:-1';
		</script>


      </div>
      <footer id="footer">
  <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": { 
        preferredFont: "TeX", 
        availableFonts: ["STIX","TeX"], 
        linebreaks: { automatic:true }, 
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) 
    },
    tex2jax: { 
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ], 
        processEscapes: true, 
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {  
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, 
        Macros: { href: "{}" } 
    },
    messageStyle: "none"
    }); 
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 ywy_c_asm<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>







    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>




</body>
</html>